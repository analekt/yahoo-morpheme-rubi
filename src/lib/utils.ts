// テキストを4KB以下のチャンクに分割
export function splitTextIntoChunks(text: string, maxBytes: number = 4000): string[] {
  const chunks: string[] = [];
  let currentChunk = '';
  const lines = text.split(/(\r?\n)/);
  
  for (const line of lines) {
    const testChunk = currentChunk + line;
    const byteLength = new TextEncoder().encode(testChunk).length;
    
    if (byteLength > maxBytes && currentChunk) {
      // 句読点、括弧で分割を試みる
      const splitPoints = [
        '。', '！', '？', '.\n', '!\n', '?\n',
        '、', '，', ',', ';\n', '：', ':\n',
        '）', ')', '】', ']', '」', '"', '"', '\'',
        '\n'
      ];
      
      let bestSplit = -1;
      for (const point of splitPoints) {
        const lastIndex = currentChunk.lastIndexOf(point);
        if (lastIndex > bestSplit) {
          bestSplit = lastIndex + point.length;
        }
      }
      
      if (bestSplit > 0) {
        chunks.push(currentChunk.substring(0, bestSplit));
        currentChunk = currentChunk.substring(bestSplit) + line;
      } else {
        chunks.push(currentChunk);
        currentChunk = line;
      }
    } else {
      currentChunk = testChunk;
    }
  }
  
  if (currentChunk) {
    chunks.push(currentChunk);
  }
  
  return chunks.filter(chunk => chunk.trim().length > 0);
}

// 常用漢字データ（完全版）
export const JOYO_KANJI = new Set([
  "𠮟", "一", "丁", "七", "万", "丈", "三", "上", "下", "不", "与", "且", "世", "丘", "丙", "両", "並", "中", "串", "丸", "丹", "主", "丼", "久", "乏", "乗", "乙", "九", "乞", "乱", "乳", "乾", "亀", "了", "予", "争", "事", "二", "互", "五", "井", "亜", "亡", "交", "享", "京", "亭", "人", "仁", "今", "介", "仏", "仕", "他", "付", "仙", "代", "令", "以", "仮", "仰", "仲", "件", "任", "企", "伎", "伏", "伐", "休", "会", "伝", "伯", "伴", "伸", "伺", "似", "但", "位", "低", "住", "佐", "体", "何", "余", "作", "佳", "併", "使", "例", "侍", "供", "依", "価", "侮", "侯", "侵", "侶", "便", "係", "促", "俊", "俗", "保", "信", "修", "俳", "俵", "俸", "俺", "倉", "個", "倍", "倒", "候", "借", "倣", "値", "倫", "倹", "偉", "偏", "停", "健", "側", "偵", "偶", "偽", "傍", "傑", "傘", "備", "催", "傲", "債", "傷", "傾", "僅", "働", "像", "僕", "僚", "僧", "僻", "儀", "億", "儒", "儖", "償", "優", "元", "兄", "充", "兆", "先", "光", "克", "免", "児", "党", "兜", "入", "全", "八", "公", "六", "共", "兵", "其", "具", "典", "兼", "内", "円", "冊", "再", "冒", "冗", "写", "冠", "冬", "冰", "冷", "准", "凋", "凌", "凍", "凝", "凡", "処", "凶", "凸", "凹", "出", "函", "刀", "刃", "分", "切", "刈", "刊", "刑", "列", "初", "判", "別", "利", "到", "制", "刷", "券", "刹", "刺", "刻", "剃", "削", "前", "剖", "剛", "剝", "副", "剰", "割", "創", "劇", "劉", "力", "功", "加", "劣", "助", "努", "励", "労", "効", "勇", "勉", "勘", "務", "勝", "募", "勢", "勤", "勧", "勲", "勾", "匁", "匂", "包", "化", "北", "匠", "匹", "区", "医", "匿", "十", "千", "升", "午", "半", "卑", "卒", "卓", "協", "南", "単", "博", "占", "印", "危", "即", "却", "卵", "厚", "原", "厄", "厘", "厳", "去", "参", "又", "及", "友", "双", "反", "収", "叔", "取", "受", "叙", "口", "古", "句", "叫", "召", "可", "台", "叱", "史", "右", "叶", "号", "司", "各", "合", "吉", "同", "名", "后", "吏", "吐", "向", "君", "吟", "否", "吸", "吹", "呂", "呆", "呈", "呉", "告", "呑", "呪", "呼", "命", "咋", "和", "咲", "哀", "品", "哨", "哲", "員", "哺", "商", "問", "啓", "善", "喉", "喚", "喜", "喝", "喧", "喪", "喫", "営", "嗅", "嘆", "嘱", "噴", "器", "噛", "囚", "四", "回", "因", "団", "困", "囲", "図", "固", "国", "圏", "園", "土", "圧", "在", "圭", "地", "坂", "均", "坊", "坑", "坪", "垂", "型", "垣", "埋", "城", "域", "執", "培", "基", "埼", "堀", "堂", "堅", "堆", "堕", "堤", "堪", "報", "場", "塀", "塁", "塊", "塑", "塔", "塗", "塚", "塩", "填", "塾", "境", "墓", "増", "墜", "墨", "墳", "墾", "壁", "壇", "壊", "壌", "士", "壮", "声", "壱", "売", "変", "夏", "夕", "外", "多", "夜", "夢", "大", "天", "太", "夫", "央", "失", "奇", "奈", "奉", "奏", "契", "奔", "套", "奥", "女", "奴", "好", "如", "妃", "妄", "妊", "妙", "妥", "妨", "妬", "妹", "妻", "姉", "始", "姓", "委", "姫", "姻", "姿", "威", "娘", "娠", "婆", "婚", "婦", "婿", "媒", "嫁", "嫉", "嫌", "子", "孔", "字", "存", "孝", "孟", "季", "孤", "学", "孫", "宅", "宇", "守", "安", "宋", "完", "宍", "宏", "宗", "官", "宙", "定", "宛", "宜", "宝", "実", "客", "宣", "室", "宮", "宰", "害", "宴", "宵", "家", "容", "宿", "寂", "寄", "寅", "密", "富", "寒", "寛", "寝", "察", "寡", "寧", "審", "寮", "寸", "寺", "対", "寿", "封", "専", "射", "将", "尉", "尊", "尋", "導", "小", "少", "尚", "就", "尺", "尻", "尼", "尽", "尾", "尿", "局", "居", "屈", "届", "屋", "展", "属", "屠", "屡", "層", "履", "屯", "山", "岐", "岡", "岩", "岬", "岳", "岸", "峡", "峰", "島", "崇", "崎", "崩", "嵐", "嵩", "嶺", "巌", "川", "州", "巡", "巣", "工", "左", "巧", "巨", "差", "己", "巻", "市", "布", "帆", "希", "帝", "帥", "師", "席", "帯", "帰", "帳", "常", "帽", "幅", "幕", "幣", "干", "平", "年", "幸", "幹", "幻", "幼", "幽", "幾", "庁", "広", "庄", "床", "序", "底", "庖", "店", "庚", "府", "度", "座", "庫", "庭", "庶", "康", "庸", "廃", "廉", "廊", "廷", "延", "廻", "建", "弁", "弄", "弊", "式", "弐", "弓", "弔", "引", "弘", "弛", "弟", "弦", "弧", "弱", "張", "強", "弾", "当", "彙", "形", "彩", "彫", "彰", "影", "役", "彼", "往", "征", "径", "待", "律", "後", "徐", "徒", "従", "得", "御", "復", "循", "微", "徳", "徴", "徹", "心", "必", "忌", "忍", "志", "忘", "忙", "応", "忠", "快", "念", "怒", "怖", "思", "怠", "急", "性", "怨", "怪", "恋", "恐", "恒", "恣", "恥", "恨", "恩", "恭", "息", "恵", "悔", "悟", "悠", "患", "悦", "悩", "悪", "悲", "悼", "情", "惑", "惜", "惨", "惰", "想", "愁", "愉", "愚", "愛", "感", "慈", "態", "慌", "慎", "慕", "慢", "慣", "慨", "慮", "慰", "慶", "憂", "憎", "憤", "憧", "憩", "憲", "憶", "懇", "應", "懐", "懲", "懸", "成", "我", "戒", "戦", "戯", "戴", "戸", "所", "扇", "扉", "手", "才", "打", "払", "扱", "扶", "批", "承", "技", "抄", "把", "抑", "投", "抗", "折", "抜", "択", "披", "抱", "抵", "抹", "押", "抽", "担", "拍", "拐", "拒", "拓", "拘", "拙", "招", "拝", "拠", "拡", "括", "拭", "拳", "拶", "拷", "拾", "持", "指", "挑", "挙", "挟", "振", "挿", "捉", "捕", "捗", "捜", "捨", "据", "捻", "掃", "授", "掌", "排", "掘", "掛", "掟", "採", "探", "接", "控", "推", "措", "掲", "描", "提", "揚", "換", "握", "揮", "援", "揺", "損", "搬", "搭", "携", "搾", "摂", "摘", "摩", "摯", "撃", "撤", "撮", "撲", "擁", "操", "擦", "擬", "支", "改", "攻", "放", "政", "故", "敏", "救", "敗", "教", "敢", "散", "敬", "数", "整", "敵", "敷", "文", "斉", "斎", "斐", "斑", "斗", "料", "斜", "斤", "斥", "断", "新", "方", "施", "旅", "旋", "族", "旗", "既", "日", "旦", "旧", "旨", "早", "旬", "昆", "昇", "明", "昏", "易", "昔", "星", "映", "春", "昨", "昭", "是", "昼", "時", "晩", "普", "景", "晴", "晶", "智", "暁", "暇", "暑", "暖", "暗", "暦", "暫", "暮", "暴", "曇", "曖", "曜", "曲", "更", "書", "曹", "曽", "替", "最", "月", "有", "朋", "服", "朔", "朕", "朗", "望", "朝", "期", "木", "未", "末", "本", "札", "朱", "朴", "机", "朽", "杉", "李", "杏", "材", "村", "杖", "杜", "束", "条", "来", "杯", "東", "松", "板", "析", "枕", "林", "枚", "果", "枝", "柄", "柏", "某", "柔", "柘", "柱", "柳", "柵", "査", "柿", "栃", "栄", "栓", "校", "株", "核", "根", "格", "栽", "桁", "桃", "案", "桑", "桜", "桟", "梅", "梗", "梨", "械", "棄", "棋", "棒", "棚", "棟", "森", "棺", "椅", "植", "椎", "椒", "検", "椿", "楊", "楓", "楕", "楚", "楯", "業", "楼", "極", "榎", "構", "槽", "樫", "樹", "樺", "橋", "橘", "機", "橡", "檀", "檎", "櫛", "欄", "欠", "次", "欧", "欲", "欺", "款", "歌", "歓", "止", "正", "此", "武", "歩", "歯", "歳", "歴", "死", "殆", "殉", "殊", "残", "殖", "殴", "段", "殺", "殻", "殿", "毀", "母", "毎", "毒", "比", "毛", "氏", "民", "気", "水", "氷", "永", "汁", "求", "汎", "汗", "汚", "江", "池", "汰", "汽", "沃", "沈", "沖", "沙", "没", "沢", "河", "沸", "油", "治", "沼", "沿", "況", "泉", "泊", "泌", "法", "泡", "波", "泣", "泥", "注", "泰", "泳", "洋", "洗", "洞", "津", "洪", "活", "派", "流", "浄", "浅", "浜", "浦", "浪", "浮", "浴", "海", "浸", "消", "涙", "涯", "液", "涼", "淑", "淡", "深", "混", "清", "済", "渇", "渉", "渋", "渓", "減", "渡", "渦", "温", "測", "港", "游", "湖", "湯", "湾", "湿", "満", "源", "準", "溝", "溶", "溺", "滋", "滑", "滝", "滞", "滴", "漁", "漂", "漆", "漏", "演", "漠", "漢", "漫", "漬", "漸", "潔", "潜", "潟", "潤", "潮", "澄", "激", "濁", "濃", "濡", "濫", "瀬", "火", "灯", "灰", "災", "炉", "炊", "炎", "炭", "点", "為", "烈", "焉", "無", "焦", "然", "焼", "煉", "煙", "照", "煩", "熊", "熟", "熱", "燃", "燈", "燥", "爆", "爪", "爵", "父", "爽", "片", "版", "牙", "牛", "牧", "物", "牲", "特", "犬", "犯", "状", "狂", "狩", "独", "狭", "狼", "猛", "猟", "猪", "献", "猫", "猶", "獄", "獣", "獲", "玄", "率", "玉", "王", "珍", "珠", "班", "現", "球", "理", "琴", "瓦", "甘", "甚", "生", "産", "用", "田", "由", "甲", "申", "男", "町", "画", "界", "畏", "留", "略", "番", "異", "疎", "疑", "疫", "疲", "疾", "病", "症", "痕", "痘", "痛", "痢", "痩", "痴", "療", "癒", "癖", "発", "登", "白", "百", "的", "皆", "皇", "皮", "皿", "盆", "益", "盛", "盟", "監", "盤", "目", "盲", "直", "相", "盾", "省", "眉", "看", "県", "眠", "眺", "眼", "着", "睡", "督", "瞬", "瞭", "瞳", "矛", "矢", "知", "短", "矯", "石", "砂", "研", "砕", "砲", "破", "硝", "硫", "硬", "碁", "碑", "確", "磁", "磨", "礁", "礎", "示", "礼", "社", "祈", "祉", "祖", "祝", "神", "祭", "禁", "禄", "禅", "禍", "福", "秀", "私", "秋", "科", "秒", "秘", "租", "秩", "称", "移", "程", "税", "稚", "種", "稲", "稼", "稽", "稿", "穀", "穂", "積", "穏", "穫", "穴", "究", "空", "窃", "突", "窒", "窓", "窟", "窮", "窯", "立", "竜", "章", "童", "竣", "端", "競", "竹", "笑", "笛", "笠", "符", "第", "筆", "等", "筋", "筒", "答", "策", "箇", "箋", "箱", "箸", "節", "範", "築", "篇", "篤", "簡", "簿", "籍", "米", "粉", "粋", "粒", "粗", "粘", "粛", "粟", "粧", "精", "糖", "糧", "糸", "系", "糾", "紀", "約", "紅", "紋", "納", "紐", "純", "紙", "級", "紛", "素", "紡", "索", "紫", "累", "細", "紳", "紹", "紺", "終", "組", "経", "結", "絞", "絡", "給", "統", "絵", "絶", "絹", "継", "続", "綻", "維", "綱", "網", "綴", "綺", "綻", "綿", "緊", "総", "緑", "緒", "線", "締", "編", "緩", "緯", "練", "縁", "縄", "縛", "縞", "縦", "縫", "縮", "績", "繁", "繊", "繋", "繕", "繰", "繻", "纂", "罪", "置", "罰", "署", "罵", "罷", "羅", "羊", "美", "群", "羨", "義", "羽", "翁", "翌", "習", "翻", "翼", "老", "考", "者", "而", "耐", "耕", "耗", "耳", "聖", "聞", "聴", "職", "肉", "肌", "肖", "肘", "肝", "股", "肢", "肥", "肩", "肪", "肯", "育", "肺", "胃", "胆", "背", "胎", "胞", "胴", "胸", "能", "脂", "脅", "脆", "脇", "脈", "脊", "脚", "脱", "脳", "腎", "腐", "腕", "腰", "腸", "腹", "腺", "膚", "膜", "膝", "膨", "臓", "臣", "臨", "自", "臭", "至", "致", "臼", "舌", "舎", "舗", "舞", "舟", "航", "般", "舶", "舷", "船", "艇", "艦", "良", "色", "艶", "芋", "芝", "芯", "花", "芳", "芸", "芽", "苗", "若", "苦", "英", "茂", "茎", "茜", "茶", "草", "荒", "荘", "荷", "菊", "菌", "菓", "菜", "華", "萩", "落", "葉", "著", "葬", "葛", "蒸", "蒲", "蓄", "蓋", "蔑", "蔵", "薄", "薦", "薪", "薬", "藍", "藤", "藩", "藻", "虎", "虐", "虚", "虜", "虫", "蚊", "蛇", "蛍", "蛮", "蜂", "蜜", "融", "螺", "血", "衆", "行", "術", "街", "衛", "衝", "衡", "衣", "表", "衰", "袋", "被", "裁", "裂", "装", "裏", "裕", "補", "裸", "製", "複", "褐", "襟", "西", "要", "覆", "見", "規", "視", "覚", "覧", "親", "観", "角", "解", "触", "言", "訂", "計", "討", "訓", "託", "記", "訟", "訪", "設", "許", "訳", "訴", "診", "証", "詐", "詔", "評", "詞", "詠", "試", "詩", "詮", "詰", "話", "詳", "誇", "誉", "誌", "認", "誓", "誕", "語", "誠", "誤", "説", "読", "誰", "課", "諦", "調", "談", "請", "諸", "諺", "諾", "謀", "謁", "謄", "謎", "謙", "講", "謝", "謡", "謬", "謹", "識", "譜", "警", "議", "譲", "護", "谷", "豆", "豊", "豚", "象", "豪", "貌", "貝", "貞", "負", "財", "貢", "貧", "貨", "販", "貪", "貫", "責", "貯", "貰", "貴", "買", "費", "貸", "貿", "賀", "賃", "賄", "資", "賊", "賛", "賜", "賞", "賠", "賢", "賦", "質", "購", "贈", "赤", "赦", "走", "赴", "起", "超", "越", "趣", "趨", "足", "跡", "跨", "跳", "踊", "踏", "踪", "躍", "身", "車", "軌", "軍", "軒", "軟", "転", "軸", "軽", "較", "載", "輝", "輩", "輪", "輸", "輻", "辛", "辞", "辰", "辱", "農", "辺", "辻", "込", "迅", "迎", "近", "返", "迫", "迭", "述", "迷", "追", "退", "送", "逃", "逆", "透", "逐", "逓", "途", "通", "逝", "速", "造", "連", "逮", "週", "進", "逸", "遂", "遅", "遇", "遊", "運", "遍", "過", "道", "達", "違", "遠", "遣", "適", "遭", "遮", "遵", "遷", "選", "遺", "避", "還", "邦", "邪", "部", "郊", "郎", "郡", "部", "郵", "郷", "都", "酌", "配", "酎", "酒", "酔", "酢", "酪", "酬", "酵", "酷", "酸", "醇", "醒", "醜", "醸", "釈", "里", "重", "野", "量", "金", "釘", "針", "釣", "鈍", "鈴", "鉄", "鉛", "鉢", "鉱", "銀", "銃", "銅", "銘", "鋭", "鋼", "錠", "錦", "錬", "録", "鍋", "鍛", "鍵", "鎖", "鎮", "鏡", "鐘", "鑑", "長", "門", "閉", "開", "閑", "間", "関", "閣", "閥", "閲", "闇", "防", "阻", "附", "降", "限", "院", "陣", "除", "陥", "陪", "陰", "陳", "陵", "陶", "陸", "険", "陽", "隅", "隆", "隊", "階", "随", "隔", "隙", "際", "障", "隠", "隣", "隷", "隻", "雄", "雅", "集", "雇", "雌", "雑", "離", "難", "雨", "雪", "雲", "零", "雷", "電", "需", "震", "霊", "霜", "霧", "露", "青", "静", "非", "面", "革", "靴", "韓", "音", "韻", "響", "頁", "頂", "頃", "項", "順", "須", "頑", "頒", "頓", "領", "頭", "頻", "頼", "題", "額", "顎", "顔", "願", "類", "顧", "風", "飛", "食", "飢", "飯", "飲", "飼", "飽", "飾", "餅", "養", "餌", "館", "首", "香", "馬", "馳", "駄", "駅", "駆", "駐", "騎", "騒", "験", "騰", "驚", "骨", "髄", "高", "髪", "鬼", "魂", "魅", "魔", "魚", "鮮", "鳥", "鳴", "鶏", "麗", "麦", "麻", "黄", "黒", "黙", "鼓", "鼻", "齢"
]);

// 文字列が常用漢字のみで構成されているかチェック
export function isOnlyJoyoKanji(text: string): boolean {
  for (const char of text) {
    if (isKanji(char) && !JOYO_KANJI.has(char)) {
      return false;
    }
  }
  return true;
}

// 漢字かどうか判定
export function isKanji(char: string): boolean {
  const code = char.charCodeAt(0);
  return (
    (code >= 0x4e00 && code <= 0x9faf) || // CJK統合漢字
    (code >= 0x3400 && code <= 0x4dbf) || // CJK拡張A
    (code >= 0x20000 && code <= 0x2a6df) || // CJK拡張B
    (code >= 0x2a700 && code <= 0x2b73f) || // CJK拡張C
    (code >= 0x2b740 && code <= 0x2b81f) || // CJK拡張D
    (code >= 0x2b820 && code <= 0x2ceaf) // CJK拡張E
  );
}

// 送り仮名分離ロジック
export function separateOkurigana(surface: string, reading: string): { 
  kanjiPart: string; 
  kanjiReading: string; 
  okurigana: string; 
} {
  // 表層形と読みが同じ場合は分離不要
  if (surface === reading) {
    return { kanjiPart: surface, kanjiReading: reading, okurigana: '' };
  }

  // 表層形の末尾からひらがなを探す
  let okuriganaStart = surface.length;
  for (let i = surface.length - 1; i >= 0; i--) {
    const char = surface[i];
    const code = char.charCodeAt(0);
    // ひらがなかどうか判定
    if (code >= 0x3040 && code <= 0x309f) {
      okuriganaStart = i;
    } else {
      break;
    }
  }
  
  // 送り仮名が見つからない場合
  if (okuriganaStart === surface.length) {
    return { kanjiPart: surface, kanjiReading: reading, okurigana: '' };
  }

  const kanjiPart = surface.substring(0, okuriganaStart);
  const okuriganaPart = surface.substring(okuriganaStart);
  
  // 読みの末尾から送り仮名部分を除去
  let kanjiReading = reading;
  
  if (okuriganaPart.length > 0) {
    // 読みの末尾が送り仮名と一致するかチェック
    if (reading.endsWith(okuriganaPart)) {
      kanjiReading = reading.substring(0, reading.length - okuriganaPart.length);
    } else {
      // 完全一致しない場合、後ろから文字単位で比較
      let matchLength = 0;
      for (let i = 0; i < Math.min(reading.length, okuriganaPart.length); i++) {
        const readingChar = reading[reading.length - 1 - i];
        const okuriganaChar = okuriganaPart[okuriganaPart.length - 1 - i];
        
        if (readingChar === okuriganaChar) {
          matchLength++;
        } else {
          break;
        }
      }
      
      kanjiReading = reading.substring(0, reading.length - matchLength);
    }
  }
  
  return {
    kanjiPart: kanjiPart,
    kanjiReading: kanjiReading,
    okurigana: okuriganaPart
  };
}

// ルビ形式での出力
export function formatWithRuby(
  surface: string,
  reading: string,
  format: 'xhtml' | 'bracket'
): string {
  if (format === 'xhtml') {
    return `<ruby><rb>${surface}</rb><rt>${reading}</rt></ruby>`;
  } else {
    return `${surface}【${reading}】`;
  }
}